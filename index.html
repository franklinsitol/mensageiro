<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat P2P 01</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #messages { border: 1px solid #ccc; height: 300px; overflow-y: scroll; margin-bottom: 10px; padding: 10px; }
        #input { width: calc(100% - 70px); }
        button { margin-left: 10px; }
    </style>
</head>
<body>

<h2>Chat P2P</h2>
<div id="messages"></div>
<input type="text" id="input" placeholder="Digite sua mensagem..." />
<button id="sendBtn">Enviar</button>
<button id="connectBtn">Criar Conexão</button>
<textarea id="sdpInput" rows="4" placeholder="Cole SDP aqui para conectar..."></textarea>
<button id="connectFromSDP">Conectar com SDP</button>
<div id="status"></div>

<script>
    let peerConnection;
    let dataChannel;
    const messagesDiv = document.getElementById('messages');
    const input = document.getElementById('input');
    const statusDiv = document.getElementById('status');

    // Função para exibir mensagens
    function appendMessage(message) {
        messagesDiv.innerHTML += `<div>${message}</div>`;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Função de criação da conexão
    function createConnection() {
        // Adiciona o servidor STUN
        const iceServers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        peerConnection = new RTCPeerConnection(iceServers);

        // Cria o canal de dados
        dataChannel = peerConnection.createDataChannel("chat");

        // Define os handlers do canal de dados
        dataChannel.onopen = () => {
            updateStatus("Conexão estabelecida com sucesso!");
        };

        dataChannel.onmessage = (event) => {
            appendMessage("Amigo: " + event.data);
        };

        // Adiciona tratamento de ICE candidates
        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                console.log("Candidato ICE:", event.candidate);
            }
        };

        // Cria a oferta e define a descrição local
        peerConnection.createOffer()
            .then(offer => {
                return peerConnection.setLocalDescription(offer);
            })
            .then(() => {
                const sdpTextArea = document.getElementById('sdpInput');
                sdpTextArea.value = peerConnection.localDescription.sdp;
                updateStatus("Conexão criada. Cole o SDP no outro dispositivo.");
            })
            .catch(error => {
                console.error("Erro ao criar a oferta:", error);
            });
    }

    // Função para conectar usando SDP
    function connectToPeer(sdp) {
        // Adiciona o servidor STUN
        const iceServers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        peerConnection = new RTCPeerConnection(iceServers);

        peerConnection.ondatachannel = event => {
            dataChannel = event.channel;

            dataChannel.onopen = () => {
                updateStatus("Conexão estabelecida com sucesso!");
            };

            dataChannel.onmessage = (event) => {
                appendMessage("Amigo: " + event.data);
            };
        };

        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                console.log("Candidato ICE:", event.candidate);
            }
        };

        // Ajuste aqui para lidar corretamente com SDP
        peerConnection.setRemoteDescription(new RTCSessionDescription({ type: 'offer', sdp }))
            .then(() => peerConnection.createAnswer())
            .then(answer => {
                return peerConnection.setLocalDescription(answer);
            })
            .then(() => {
                updateStatus("Aguardando conexão...");
            })
            .catch(error => {
                console.error("Erro ao conectar:", error);
            });
    }

    // Atualizar status
    function updateStatus(message) {
        statusDiv.textContent = message;
    }

    // Enviar mensagem
    document.getElementById('sendBtn').onclick = () => {
        if (dataChannel && dataChannel.readyState === 'open') {
            const message = input.value;
            dataChannel.send(message);
            appendMessage(`Você: ${message}`);
            input.value = '';
        } else {
            alert("Conexão não estabelecida ainda!");
        }
    };

    // Conectar
    document.getElementById('connectBtn').onclick = createConnection;

    // Conectar a partir do SDP
    document.getElementById('connectFromSDP').onclick = () => {
        const sdp = document.getElementById('sdpInput').value;
        connectToPeer(sdp);
    };

</script>
</body>
</html>
