<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4Chat WebRTC</title>
    <style>
        body { font-family: Arial, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #f0f0f0; }
        #chat-container { width: 90%; max-width: 600px; background: white; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); overflow: hidden; display: flex; flex-direction: column; }
        #messages { flex: 1; padding: 20px; overflow-y: auto; }
        .message { margin: 10px 0; padding: 10px; border-radius: 5px; background: #e0e0e0; }
        .my-message { background: #0084ff; color: white; }
        #input-container { display: flex; border-top: 1px solid #ddd; }
        #message-input { flex: 1; padding: 10px; border: none; outline: none; }
        #send-button { padding: 10px; background: #0084ff; border: none; color: white; cursor: pointer; }
        .floating-button { position: fixed; bottom: 20px; right: 20px; background: #0084ff; color: white; border: none; border-radius: 50%; width: 50px; height: 50px; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .hidden { display: none; }
        #contacts { padding: 20px; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; box-shadow: 0 0 10px rgba(0,0,0,0.1); border-radius: 10px; width: 90%; max-width: 400px; z-index: 100; }
        #contact-name { margin-bottom: 10px; }
        button { margin-top: 10px; padding: 10px; width: 100%; border: none; border-radius: 5px; cursor: pointer; }
        #create-offer { background: #0084ff; color: white; }
        #create-answer { background: #00aaff; color: white; }
        #set-answer { background: #0077aa; color: white; }
        textarea { width: 100%; height: 80px; margin-top: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
    </style>
</head>
<body>
    <div id="chat-container">
        <div id="messages"></div>
        <div id="input-container">
            <input type="text" id="message-input" placeholder="Digite sua mensagem...">
            <button id="send-button" onclick="sendMessage()">Enviar</button>
        </div>
    </div>
    <button class="floating-button" onclick="toggleContacts()">⚙️</button>
    <div id="contacts" class="hidden">
        <input type="text" id="contact-name" placeholder="Nome do contato">
        <button id="create-offer" onclick="createOffer()">Criar Oferta</button>
        <textarea id="offer" placeholder="Oferta SDP"></textarea>
        <textarea id="answer" placeholder="Resposta SDP"></textarea>
        <button id="create-answer" onclick="createAnswer()">Criar Resposta</button>
        <button id="set-answer" onclick="setAnswer()">Definir Resposta</button>
    </div>

    <script>
        let messagesContainer = document.getElementById('messages');
        let offerTextarea = document.getElementById('offer');
        let answerTextarea = document.getElementById('answer');
        let localConnection;
        let remoteConnection;
        let sendChannel;
        let receiveChannel;
        let messageQueue = [];
        let db;

        // Inicializa o IndexedDB
        let request = indexedDB.open("chatDatabase", 1);
        request.onupgradeneeded = function(event) {
            db = event.target.result;
            let objectStore = db.createObjectStore("messages", { autoIncrement: true });
            objectStore.createIndex("timestamp", "timestamp", { unique: false });
            objectStore.createIndex("contact", "contact", { unique: false });
            let webrtcStore = db.createObjectStore("webrtc", { keyPath: "id" });
        };
        request.onsuccess = function(event) {
            db = event.target.result;
            loadMessages();
            loadWebRTCData();
        };

        function loadWebRTCData() {
            let transaction = db.transaction(["webrtc"], "readonly");
            let objectStore = transaction.objectStore("webrtc");
            let request = objectStore.get("webrtcData");

            request.onsuccess = function(event) {
                let data = event.target.result;
                if (data) {
                    offerTextarea.value = data.offer || "";
                    answerTextarea.value = data.answer || "";
                }
            };
        }

        function createOffer() {
            localConnection = new RTCPeerConnection();
            sendChannel = localConnection.createDataChannel("sendChannel");
            setupSendChannel(sendChannel);

            localConnection.onicecandidate = e => {
                if (!e.candidate) {
                    offerTextarea.value = JSON.stringify(localConnection.localDescription);
                    storeWebRTCData({ id: "webrtcData", offer: offerTextarea.value, answer: "" });
                }
            };

            localConnection.createOffer()
                .then(o => localConnection.setLocalDescription(o));
        }

        function setupSendChannel(channel) {
            channel.onopen = () => flushMessageQueue();
            channel.onclose = () => console.log("Canal de dados fechado");
            channel.onmessage = e => displayMessage(e.data, "Contato"); // Recebe mensagens do outro lado
        }

        function createAnswer() {
            remoteConnection = new RTCPeerConnection();
            remoteConnection.ondatachannel = e => {
                receiveChannel = e.channel;
                setupSendChannel(receiveChannel); // Configura o canal de recebimento
            };

            remoteConnection.onicecandidate = e => {
                if (!e.candidate) {
                    answerTextarea.value = JSON.stringify(remoteConnection.localDescription);
                    storeWebRTCData({ id: "webrtcData", offer: offerTextarea.value, answer: answerTextarea.value });
                }
            };

            let offer = JSON.parse(offerTextarea.value);
            remoteConnection.setRemoteDescription(new RTCSessionDescription(offer))
                .then(() => remoteConnection.createAnswer())
                .then(a => remoteConnection.setLocalDescription(a));
        }

        function setAnswer() {
            let answer = JSON.parse(answerTextarea.value);
            localConnection.setRemoteDescription(new RTCSessionDescription(answer));
        }

        function sendMessage() {
            let input = document.getElementById('message-input');
            if (input.value.trim() === "") return;

            let message = {
                text: input.value,
                timestamp: Date.now(),
                sender: "Eu"
            };

            messageQueue.push(message);
            storeMessage(message);
            displayMessage(message.text, message.sender);
            flushMessageQueue();
            input.value = '';
        }

        function storeMessage(message) {
            let transaction = db.transaction(["messages"], "readwrite");
            let objectStore = transaction.objectStore("messages");
            objectStore.add(message);
        }

        function storeWebRTCData(data) {
            let transaction = db.transaction(["webrtc"], "readwrite");
            let objectStore = transaction.objectStore("webrtc");
            objectStore.put(data);
        }

        function flushMessageQueue() {
            if (sendChannel && sendChannel.readyState === 'open') {
                while (messageQueue.length > 0) {
                    let message = messageQueue.shift();
                    sendChannel.send(message.text);
                    console.log("Mensagem enviada:", message.text);
                }
            }
        }

        function displayMessage(message, sender) {
            let messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            if (sender === "Eu") {
                messageDiv.classList.add('my-message');
            }
            messageDiv.textContent = `${sender}: ${message}`;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function toggleContacts() {
            let contacts = document.getElementById('contacts');
            contacts.classList.toggle('hidden');
        }

        function loadMessages() {
            let transaction = db.transaction(["messages"], "readonly");
            let objectStore = transaction.objectStore("messages");
            objectStore.openCursor().onsuccess = function(event) {
                let cursor = event.target.result;
                if (cursor) {
                    displayMessage(cursor.value.text, cursor.value.sender);
                    cursor.continue();
                }
            };
        }
    </script>
</body>
</html>
