<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#FF9BB3">
    <meta name="description" content="BunnyChat - Mensagens Fofinhas e Seguras">
    <title>BunnyChat - Mensagens Fofinhas</title>
    
    <!-- Manifest PWA -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Ícones para PWA -->
    <link rel="icon" href="icons/favicon.ico">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    
    <!-- CSS e Fontes com pré-carregamento -->
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/gun/gun.js" as="script">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/gun/sea.js" as="script">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js" as="script">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js" as="script">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&family=Short+Stack&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ... (mantenha todos os estilos anteriores) ... */
    </style>
</head>
<body>
    <!-- ... (mantenha toda a estrutura HTML anterior) ... -->

    <script>
        // Configuração otimizada do Gun.js
        const gun = Gun({
            peers: ['https://gun-manhattan.herokuapp.com/gun'],
            localStorage: false,
            radisk: false
        });

        // Estado simplificado da aplicação
        const state = {
            currentUser: null,
            currentContact: null,
            processedMessages: new Set(),
            lastScannedQR: null
        };

        // Cache de elementos DOM
        const elements = {
            displays: {
                chatMessages: document.querySelector('.chat-messages'),
                qrCode: document.querySelector('.qr-code canvas'),
                userId: document.querySelector('#userId')
            },
            inputs: {
                message: document.querySelector('#messageInput')
            },
            video: document.querySelector('#qrScanner video'),
            scanOverlay: document.querySelector('.scan-overlay')
        };

        // Função utilitária para mostrar notificações
        function showNotification(message, type = 'info') {
            console.log(`[${type}] ${message}`);
            // Implementação da notificação UI
        }

        // Função otimizada para enviar mensagens
        async function sendMessage(contactId, messageText) {
            if (!state.currentUser || !messageText.trim()) return;
            
            try {
                const messageId = Gun.text.random(16);
                const message = {
                    id: messageId,
                    sender: state.currentUser.id,
                    receiver: contactId,
                    text: messageText.trim(),
                    timestamp: Date.now(),
                    read: false
                };
                
                if (state.processedMessages.has(messageId)) return;
                state.processedMessages.add(messageId);
                
                // Envio otimizado usando Promise.all
                await Promise.all([
                    gun.get('users').get(state.currentUser.id).get('messages').get(messageId).put(message),
                    gun.get('users').get(contactId).get('messages').get(messageId).put(message)
                ]);
                
                elements.inputs.message.value = '';
            } catch (error) {
                showNotification('Erro ao enviar mensagem', 'error');
                console.error('Erro no sendMessage:', error);
            }
        }

        // Função otimizada para carregar mensagens
        function loadChatMessages(contactId) {
            if (!state.currentUser || !contactId) return;
            
            elements.displays.chatMessages.innerHTML = '';
            
            const messages = gun.get('users').get(state.currentUser.id).get('messages');
            const messageElements = [];
            let hasMessages = false;
            
            messages.map().once((message, id) => {
                if (!message || state.processedMessages.has(message.id)) return;
                
                state.processedMessages.add(message.id);
                
                const isRelevant = (message.sender === contactId && message.receiver === state.currentUser.id) || 
                                  (message.sender === state.currentUser.id && message.receiver === contactId);
                if (!isRelevant) return;
                
                hasMessages = true;
                messageElements.push(createMessageElement(message));
                
                if (!isSender && !message.read) {
                    markMessageAsRead(id, message);
                }
            });
            
            if (hasMessages) {
                elements.displays.chatMessages.append(...messageElements);
                elements.displays.chatMessages.scrollTop = elements.displays.chatMessages.scrollHeight;
            } else {
                showEmptyState();
            }
        }

        function createMessageElement(message) {
            const isSender = message.sender === state.currentUser.id;
            const senderName = isSender ? 'Você' : state.currentContact.name;
            
            const messageElement = document.createElement('div');
            messageElement.className = 'message-item';
            messageElement.style.alignItems = isSender ? 'flex-end' : 'flex-start';
            messageElement.style.backgroundColor = isSender ? 'var(--secondary)' : 'white';
            
            messageElement.innerHTML = `
                <div class="message-header">
                    ${!isSender ? `<div class="avatar message-avatar">${generateAvatarIcon(state.currentContact.name)}</div>` : ''}
                    <div class="message-sender">${senderName}</div>
                    <div class="message-time">${formatTime(message.timestamp)}</div>
                </div>
                <div class="message-content">
                    ${escapeHtml(message.text)}
                </div>
            `;
            
            return messageElement;
        }

        function markMessageAsRead(id, message) {
            gun.get('users').get(state.currentUser.id).get('messages').get(id).put({
                ...message,
                read: true
            });
        }

        function showEmptyState() {
            elements.displays.chatMessages.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-comment-dots"></i>
                    <p>Nenhuma mensagem ainda</p>
                    <p>Envie uma mensagem para começar a conversa!</p>
                </div>
            `;
        }

        // Função otimizada para gerar QR Code
        async function generateQrCode() {
            if (!state.currentUser) return;
            
            try {
                const qrToken = Math.random().toString(36).slice(2, 12);
                const qrData = JSON.stringify({
                    app: "BunnyChat",
                    version: 1,
                    userId: state.currentUser.id,
                    token: qrToken,
                    timestamp: Date.now()
                });
                
                await gun.get('users').get(state.currentUser.id).put({
                    ...state.currentUser,
                    qrToken
                });
                
                QRCode.toCanvas(elements.displays.qrCode, qrData, {
                    width: 200,
                    margin: 2,
                    color: {
                        dark: '#5A2A3E',
                        light: '#FFF2F5'
                    }
                });
                
                elements.displays.userId.value = state.currentUser.id;
            } catch (error) {
                showNotification('Erro ao gerar QR Code', 'error');
                console.error('Erro no generateQrCode:', error);
            }
        }

        // Scanner de QR Code otimizado
        async function startQrScanner() {
            state.lastScannedQR = null;
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                elements.video.srcObject = stream;
                elements.video.setAttribute('playsinline', true);
                await elements.video.play();
                
                elements.video.onplaying = () => elements.scanOverlay.style.display = 'none';
                scanFrame();
            } catch (error) {
                handleCameraError(error);
            }
        }

        function scanFrame() {
            if (!elements.video.srcObject) return;
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            
            function processFrame() {
                if (state.currentScreen !== 'scan') return;
                
                try {
                    if (elements.video.readyState === elements.video.HAVE_ENOUGH_DATA) {
                        canvas.width = elements.video.videoWidth;
                        canvas.height = elements.video.videoHeight;
                        ctx.drawImage(elements.video, 0, 0, canvas.width, canvas.height);
                        
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const code = jsQR(imageData.data, imageData.width, imageData.height, {
                            inversionAttempts: 'dontInvert'
                        });
                        
                        if (code) processQRCode(code.data);
                    }
                    requestAnimationFrame(processFrame);
                } catch (error) {
                    console.error('Erro no scanner:', error);
                    stopQrScanner();
                    showNotification('Erro no scanner de QR Code', 'error');
                }
            }
            
            processFrame();
        }

        function processQRCode(data) {
            try {
                const qrData = JSON.parse(data);
                
                if (!isValidQR(qrData)) return;
                if (qrData.userId === state.currentUser.id) {
                    showNotification('Você não pode adicionar a si mesmo!');
                    return;
                }
                
                const qrKey = `${qrData.userId}-${qrData.token}`;
                if (state.lastScannedQR === qrKey) return;
                state.lastScannedQR = qrKey;
                
                if (isQRExpired(qrData.timestamp)) {
                    showNotification('QR Code expirado');
                    return;
                }
                
                verifyAndAddContact(qrData);
            } catch (error) {
                console.error('Erro ao processar QR Code:', error);
            }
        }

        function isValidQR(qrData) {
            return qrData.app === "BunnyChat" && qrData.userId && qrData.token;
        }

        function isQRExpired(timestamp) {
            return timestamp && (Date.now() - timestamp > 300000);
        }

        async function verifyAndAddContact(qrData) {
            const user = await new Promise(resolve => {
                gun.get('users').get(qrData.userId).once(resolve);
            });
            
            if (user && user.qrToken === qrData.token) {
                stopQrScanner();
                addContact(qrData.userId);
            } else {
                showNotification('QR Code inválido');
            }
        }

        function handleCameraError(error) {
            console.error('Erro ao acessar a câmera:', error);
            elements.scanOverlay.innerHTML = `
                <div>
                    <i class="fas fa-camera-slash"></i>
                    <p>Não foi possível acessar a câmera</p>
                    <p>Verifique as permissões do navegador</p>
                    <button id="tryAgainBtn" class="btn btn-small">Tentar novamente</button>
                </div>
            `;
            
            document.getElementById('tryAgainBtn').onclick = startQrScanner;
        }

        function stopQrScanner() {
            if (elements.video.srcObject) {
                elements.video.srcObject.getTracks().forEach(track => track.stop());
                elements.video.srcObject = null;
            }
            elements.scanOverlay.style.display = 'flex';
            state.lastScannedQR = null;
        }

        // Utilitários
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function generateAvatarIcon(name) {
            return name ? name.charAt(0).toUpperCase() : '?';
        }

        /* ... (outras funções auxiliares conforme necessário) ... */
    </script>
</body>
</html>
