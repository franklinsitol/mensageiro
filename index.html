<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat WebRTC</title>
    <style>
        body { font-family: Arial, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background-color: #f0f0f0; }
        #chat-container { width: 90%; max-width: 600px; background: white; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); overflow: hidden; display: flex; flex-direction: column; }
        #messages { flex: 1; padding: 20px; overflow-y: auto; }
        .message { margin: 10px 0; padding: 10px; border-radius: 5px; background: #e0e0e0; }
        .my-message { background: #0084ff; color: white; }
        #input-container { display: flex; border-top: 1px solid #ddd; }
        #message-input { flex: 1; padding: 10px; border: none; outline: none; }
        #send-button { padding: 10px; background: #0084ff; border: none; color: white; cursor: pointer; }
        .floating-button { position: fixed; bottom: 20px; right: 20px; background: #0084ff; color: white; border: none; border-radius: 50%; width: 50px; height: 50px; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .hidden { display: none; }
        #contacts { padding: 20px; }
        #contact-name { margin-bottom: 10px; }
    </style>
</head>
<body>
    <div id="chat-container">
        <div id="messages"></div>
        <div id="input-container">
            <input type="text" id="message-input" placeholder="Digite sua mensagem...">
            <button id="send-button" onclick="sendMessage()">Enviar</button>
        </div>
    </div>
    <button class="floating-button" onclick="toggleContacts()">⚙️</button>
    <div id="contacts" class="hidden">
        <input type="text" id="contact-name" placeholder="Nome do contato">
        <button onclick="createOffer()">Criar Oferta</button>
        <textarea id="offer" placeholder="Oferta SDP"></textarea>
        <textarea id="answer" placeholder="Resposta SDP"></textarea>
        <button onclick="createAnswer()">Criar Resposta</button>
        <button onclick="setAnswer()">Definir Resposta</button>
    </div>

    <script>
        let messagesContainer = document.getElementById('messages');
        let offerTextarea = document.getElementById('offer');
        let answerTextarea = document.getElementById('answer');
        let localConnection;
        let remoteConnection;
        let sendChannel;
        let receiveChannel;
        let messageQueue = [];
        let db;

        // Inicializa o IndexedDB
        let request = indexedDB.open("chatDatabase", 1);
        request.onupgradeneeded = function(event) {
            db = event.target.result;
            let objectStore = db.createObjectStore("messages", { autoIncrement: true });
            objectStore.createIndex("timestamp", "timestamp", { unique: false });
        };
        request.onsuccess = function(event) {
            db = event.target.result;
            loadMessages();
        };

        // Carrega mensagens do IndexedDB
        function loadMessages() {
            let transaction = db.transaction(["messages"], "readonly");
            let objectStore = transaction.objectStore("messages");
            let index = objectStore.index("timestamp");
            let now = Date.now();
            let range = IDBKeyRange.lowerBound(now - 24 * 60 * 60 * 1000);

            index.openCursor(range).onsuccess = function(event) {
                let cursor = event.target.result;
                if (cursor) {
                    displayMessage(cursor.value.text, cursor.value.sender);
                    cursor.continue();
                }
            };
        }

        // Cria oferta SDP
        function createOffer() {
            localConnection = new RTCPeerConnection();
            sendChannel = localConnection.createDataChannel("sendChannel");
            sendChannel.onopen = () => flushMessageQueue();
            sendChannel.onclose = () => console.log("Canal de dados fechado");

            localConnection.onicecandidate = e => {
                if (!e.candidate) {
                    offerTextarea.value = JSON.stringify(localConnection.localDescription);
                }
            };

            localConnection.createOffer()
                .then(o => localConnection.setLocalDescription(o));
        }

        // Cria resposta SDP
        function createAnswer() {
            remoteConnection = new RTCPeerConnection();
            remoteConnection.ondatachannel = e => {
                receiveChannel = e.channel;
                receiveChannel.onmessage = e => displayMessage(e.data, "Contato");
            };

            remoteConnection.onicecandidate = e => {
                if (!e.candidate) {
                    answerTextarea.value = JSON.stringify(remoteConnection.localDescription);
                }
            };

            let offer = JSON.parse(offerTextarea.value);
            remoteConnection.setRemoteDescription(new RTCSessionDescription(offer))
                .then(() => remoteConnection.createAnswer())
                .then(a => remoteConnection.setLocalDescription(a));
        }

        // Define resposta SDP
        function setAnswer() {
            let answer = JSON.parse(answerTextarea.value);
            localConnection.setRemoteDescription(new RTCSessionDescription(answer));
        }

        // Envia mensagem
        function sendMessage() {
            let input = document.getElementById('message-input');
            if (input.value.trim() === "") return;

            let message = {
                text: input.value,
                timestamp: Date.now(),
                sender: "Eu"
            };

            // Armazena a mensagem na fila
            messageQueue.push(message);
            storeMessage(message);

            // Exibe a mensagem localmente
            displayMessage(message.text, message.sender);

            // Tenta enviar a mensagem se o canal de dados estiver aberto
            flushMessageQueue();

            input.value = '';
        }

        // Armazena mensagem no IndexedDB
        function storeMessage(message) {
            let transaction = db.transaction(["messages"], "readwrite");
            let objectStore = transaction.objectStore("messages");
            objectStore.add(message);
        }

        // Envia mensagens enfileiradas
        function flushMessageQueue() {
            if (sendChannel && sendChannel.readyState === 'open') {
                while (messageQueue.length > 0) {
                    let message = messageQueue.shift();
                    sendChannel.send(message.text);
                    console.log("Mensagem enviada:", message.text);
                }
            }
        }

        // Exibe mensagens no chat
        function displayMessage(message, sender) {
            let messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            if (sender === "Eu") {
                messageDiv.classList.add('my-message');
            }
            messageDiv.textContent = `${sender}: ${message}`;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Alterna a visibilidade dos contatos
        function toggleContacts() {
            let contacts = document.getElementById('contacts');
            contacts.classList.toggle('hidden');
        }
    </script>
</body>
</html>
