<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat P2P com QR Code</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 0; padding: 0; }
    .container { max-width: 500px; margin: auto; padding: 20px; background: #fff; min-height: 100vh; display: flex; flex-direction: column; gap: 20px; }
    input, button, textarea { width: 100%; padding: 10px; margin-top: 5px; border-radius: 5px; border: 1px solid #ccc; }
    button { background-color: #007bff; color: white; border: none; cursor: pointer; }
    button:hover { background-color: #0056b3; }
    .hidden { display: none; }
    .contact { padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin-top: 5px; cursor: pointer; background: #e9e9e9; }
    .message { margin: 5px 0; padding: 10px; background: #def; border-radius: 5px; }
    .you { background: #cce5ff; text-align: right; }
    #qrcode img { max-width: 100%; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Login -->
    <div id="login">
      <h2>Cadastro</h2>
      <input id="nome" placeholder="Nome" />
      <input id="apelido" placeholder="Apelido" />
      <input id="pin" placeholder="PIN" type="password" />
      <button onclick="cadastrar()">Entrar</button>
    </div>

    <!-- Perfil -->
    <div id="perfil" class="hidden">
      <h2>Meu Perfil</h2>
      <p id="meuNome"></p>
      <div id="qrcode"></div>
      <button onclick="abrirScanner()">Adicionar Contato (QR)</button>
      <button onclick="mostrarContatos()">Ver Contatos</button>
      <button onclick="sair()">Sair</button>
    </div>

    <!-- Scanner QR -->
    <div id="scanner" class="hidden">
      <h2>Escaneie o QR Code</h2>
      <div id="reader" style="width:100%"></div>
      <button onclick="fecharScanner()">Cancelar</button>
    </div>

    <!-- Contatos -->
    <div id="contatos" class="hidden">
      <h2>Contatos</h2>
      <div id="listaContatos"></div>
      <button onclick="voltarPerfil()">Voltar</button>
    </div>

    <!-- Chat -->
    <div id="chat" class="hidden">
      <h2 id="chatCom"></h2>
      <div id="chatBox" style="flex: 1; overflow-y: auto; max-height: 300px;"></div>
      <textarea id="mensagem" rows="2" placeholder="Digite uma mensagem..."></textarea>
      <button onclick="enviarMensagem()">Enviar</button>
      <button onclick="sairChat()">Voltar</button>
    </div>
  </div>

  <script src="https://unpkg.com/simple-peer@9.11.1/simplepeer.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.0/build/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
  <script>
    let usuario = null;
    let contatos = JSON.parse(localStorage.getItem('contatos')) || [];
    let conexoes = {};
    let chatAtual = null;

    function cadastrar() {
      const nome = document.getElementById('nome').value;
      const apelido = document.getElementById('apelido').value;
      const pin = document.getElementById('pin').value;
      if (nome && apelido && pin) {
        usuario = { nome, apelido };
        localStorage.setItem('usuario', JSON.stringify(usuario));
        localStorage.setItem('pin', pin);
        mostrarPerfil();
      }
    }

    function mostrarPerfil() {
      document.getElementById('login').classList.add('hidden');
      document.getElementById('perfil').classList.remove('hidden');
      document.getElementById('meuNome').textContent = `${usuario.nome} (${usuario.apelido})`;
      QRCode.toDataURL(JSON.stringify({ nome: usuario.nome, apelido: usuario.apelido }), (err, url) => {
        if (err) {
          console.error('Erro ao gerar QR Code:', err);
          return;
        }
        document.getElementById('qrcode').innerHTML = `<img src="${url}" />`;
      });
    }

    function abrirScanner() {
      document.getElementById('perfil').classList.add('hidden');
      document.getElementById('scanner').classList.remove('hidden');
      const html5QrCode = new Html5Qrcode("reader");
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        (decoded) => {
          try {
            const novoContato = JSON.parse(decoded);
            if (!contatos.find(c => c.apelido === novoContato.apelido)) {
              contatos.push(novoContato);
              localStorage.setItem('contatos', JSON.stringify(contatos));
              alert('Contato adicionado: ' + novoContato.apelido);
            }
          } catch (e) {
            alert('Erro ao ler QR Code');
          }
          html5QrCode.stop().then(() => mostrarPerfil());
        },
        (err) => {
          console.warn('Erro na leitura:', err);
        }
      );
    }

    function fecharScanner() {
      location.reload();
    }

    function mostrarContatos() {
      document.getElementById('perfil').classList.add('hidden');
      document.getElementById('contatos').classList.remove('hidden');
      const lista = document.getElementById('listaContatos');
      lista.innerHTML = '';
      contatos.forEach(c => {
        const div = document.createElement('div');
        div.className = 'contact';
        div.textContent = `${c.nome} (${c.apelido})`;
        div.onclick = () => abrirChat(c);
        lista.appendChild(div);
      });
    }

    function voltarPerfil() {
      document.getElementById('contatos').classList.add('hidden');
      document.getElementById('perfil').classList.remove('hidden');
    }

    function abrirChat(contato) {
      chatAtual = contato;
      document.getElementById('contatos').classList.add('hidden');
      document.getElementById('chat').classList.remove('hidden');
      document.getElementById('chatCom').textContent = `Chat com ${contato.apelido}`;
      renderizarMensagens();
    }

    function sairChat() {
      document.getElementById('chat').classList.add('hidden');
      document.getElementById('contatos').classList.remove('hidden');
    }

    function renderizarMensagens() {
      const box = document.getElementById('chatBox');
      box.innerHTML = '';
      const todas = JSON.parse(localStorage.getItem('mensagens') || '{}');
      const msgs = todas[chatAtual.apelido] || [];
      const agora = Date.now();
      const filtradas = msgs.filter(m => agora - m.ts < 86400000);
      todas[chatAtual.apelido] = filtradas;
      localStorage.setItem('mensagens', JSON.stringify(todas));
      filtradas.forEach(m => {
        const div = document.createElement('div');
        div.className = 'message' + (m.de === usuario.apelido ? ' you' : '');
        div.textContent = m.texto;
        box.appendChild(div);
      });
    }

    function enviarMensagem() {
      const texto = document.getElementById('mensagem').value;
      if (!texto) return;
      const todas = JSON.parse(localStorage.getItem('mensagens') || '{}');
      todas[chatAtual.apelido] = todas[chatAtual.apelido] || [];
      todas[chatAtual.apelido].push({ texto, de: usuario.apelido, ts: Date.now() });
      localStorage.setItem('mensagens', JSON.stringify(todas));
      document.getElementById('mensagem').value = '';
      renderizarMensagens();
    }

    function sair() {
      localStorage.clear();
      location.reload();
    }

    window.onload = () => {
      const dados = JSON.parse(localStorage.getItem('usuario'));
      const pinSalvo = localStorage.getItem('pin');
      if (dados && pinSalvo) {
        const tentativa = prompt("Digite seu PIN para acessar:");
        if (tentativa === pinSalvo) {
          usuario = dados;
          mostrarPerfil();
        } else {
          alert("PIN incorreto. Acesso negado.");
        }
      }
    }
  </script>
</body>
</html>
